<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GHG Yem…ôk - Skaner</title>
    
    <!-- html5-qrcode skaner -->
    <script async src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .content-wrapper {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .scanner-container {
            text-align: center;
        }

        #reader {
            width: 100%;
            border-radius: 15px;
            overflow: hidden;
        }

        /* ‚úÖ SKAN SIYAHISI */
        .scan-list {
            max-height: 650px;
            overflow-y: auto;
        }

        .scan-list h2 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 2px solid #667eea;
            padding-bottom: 15px;
        }

        .scan-item {
            background: #f8f9fa;
            border: 2px solid #4caf50;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            animation: slideIn 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .scan-item-status {
            display: inline-block;
            background: #4caf50;
            color: white;
            padding: 6px 14px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .scan-item-name {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .scan-item-details {
            font-size: 13px;
            color: #666;
            line-height: 1.6;
        }

        .scan-item-details p {
            margin: 4px 0;
        }

        .empty-message {
            text-align: center;
            color: #999;
            padding: 40px 20px;
            font-size: 14px;
        }

        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            display: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .sync-loading {
            background: #ff9800;
        }

        .sync-success {
            background: #4caf50;
        }

        .sync-error {
            background: #f44336;
        }

        @media (max-width: 1024px) {
            .content-wrapper {
                grid-template-columns: 1fr;
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Scrollbar Stil */
        .scan-list::-webkit-scrollbar {
            width: 8px;
        }

        .scan-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .scan-list::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        .scan-list::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>üì∑ SKANER</h1>
        </div>

        <div class="content-wrapper">
            <!-- ‚úÖ SKANER -->
            <div class="section">
                <h2 style="text-align: center; margin-bottom: 20px;">üì± QR Skaneri</h2>
                <div class="scanner-container">
                    <div id="reader"></div>
                </div>
            </div>

            <!-- ‚úÖ SKAN SIYAHISI -->
            <div class="section scan-list">
                <h2>‚úÖ Skan Edil…ônl…ôr</h2>
                <div id="scanHistory">
                    <div class="empty-message">üì≠ H…ôl…ô skan yoxdur</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sync status -->
    <div class="sync-status" id="syncStatus"></div>

    <script>
        // ‚úÖ GOOGLE APPS SCRIPT URL
        const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbwdXawdXXV2y-LduvoNvK8z3Z4ISbh72QDJ_-JwFoz5qL9GpvwtXCdNOnqEcYNguPr_/exec';
        
        let html5QrcodeScanner = null;
        let scanActive = true;
        let scanHistory = [];
        
        const TICKET_MAP = {
            'b': 'breakfast',
            'l': 'lunch',
            'd': 'dinner',
            'dr': 'dry'
        };

        const TICKET_TYPES = [
            { id: 'breakfast', name: 'S…ôh…ôr Yem…ôyi', emoji: 'üåÖ' },
            { id: 'lunch', name: 'G√ºnorta Yem…ôyi', emoji: 'üåû' },
            { id: 'dinner', name: 'Ax≈üam Yem…ôyi', emoji: 'üåô' },
            { id: 'dry', name: 'Quru Talon', emoji: 'üì¶' }
        ];

        // ============================================================
        // BA≈ûLANƒûIC
        // ============================================================
        window.addEventListener('load', function() {
            console.log('üìÑ Scanner s…ôhif…ôsi y√ºkl…ôndi');
            initScanner();
            loadScanHistory();
        });

        // ============================================================
        // TARIX√á∆è Y√úKL∆è
        // ============================================================
        function loadScanHistory() {
            const saved = localStorage.getItem('scanHistory');
            if (saved) {
                scanHistory = JSON.parse(saved);
                updateHistoryUI();
            }
        }

        function saveScanHistory() {
            localStorage.setItem('scanHistory', JSON.stringify(scanHistory));
        }

        function updateHistoryUI() {
            const historyDiv = document.getElementById('scanHistory');
            
            if (scanHistory.length === 0) {
                historyDiv.innerHTML = '<div class="empty-message">üì≠ H…ôl…ô skan yoxdur</div>';
                return;
            }

            historyDiv.innerHTML = scanHistory.map((item) => `
                <div class="scan-item">
                    <span class="scan-item-status">‚úÖ T∆èSDƒ∞QL∆èNDƒ∞</span>
                    <div class="scan-item-name">${item.emoji} ${item.name}</div>
                    <div class="scan-item-details">
                        <p>üÜî <strong>ID:</strong> ${item.empId}</p>
                        <p>üìÖ <strong>Tarix:</strong> ${item.date}</p>
                        <p>üïê <strong>Saat:</strong> ${item.time}</p>
                    </div>
                </div>
            `).join('');
        }

        // ============================================================
        // SKANER ƒ∞Nƒ∞SLALIZASƒ∞YASI
        // ============================================================
        function initScanner() {
            console.log('üé¨ Skaner ba≈ülanƒ±r...');
            
            html5QrcodeScanner = new Html5QrcodeScanner(
                "reader",
                { 
                    fps: 10, 
                    qrbox: { width: 250, height: 250 },
                    aspectRatio: 1.0
                },
                false
            );

            html5QrcodeScanner.render(onScanSuccess, onScanError);
            console.log('‚úÖ Skaner i≈ül…ôyir');
        }

        // ============================================================
        // SKAN S∆èVIYY∆èTI
        // ============================================================
        function onScanSuccess(decodedText, decodedResult) {
            if (!scanActive) return;
            
            console.log('‚úÖ QR skanlandƒ±:', decodedText);
            scanActive = false;
            
            try {
                processScan(decodedText);
            } catch (e) {
                console.error('‚ùå X…ôta:', e);
                console.log('X…ôtalƒ± QR m…ôlumatƒ±:', decodedText);
                setTimeout(() => { scanActive = true; }, 2000);
            }
        }

        function onScanError(error) {
            // S…ôssiz - s…ôhif…ô y√ºkl…ôn…ôrk…ôn g√∂st…ôri≈ül…ôr buraya yazƒ±lƒ±r
        }

        // ============================================================
        // SKAN M∆èLUMATLARI ƒ∞≈ûL∆è
        // ============================================================
        function processScan(qrDataString) {
            console.log('üìä QR m…ôlumatƒ± i≈ül…ônir:', qrDataString);
            
            const parts = qrDataString.split('|');
            
            if (parts.length < 2) {
                console.error('‚ùå Yanlƒ±≈ü format - | ayƒ±rƒ±cƒ±sƒ± tapƒ±lmadƒ±');
                setTimeout(() => { scanActive = true; }, 2000);
                return;
            }
            
            const empId = parts[0];
            const typeCode = parts[1];
            const typeId = TICKET_MAP[typeCode];
            
            console.log('üìã Parsed QR:');
            console.log('   - empId:', empId);
            console.log('   - typeCode:', typeCode);
            console.log('   - typeId:', typeId);
            
            if (!typeId) {
                console.error('‚ùå Bilinm…ôy…ôn talon kodu:', typeCode);
                setTimeout(() => { scanActive = true; }, 2000);
                return;
            }

            const ticketType = TICKET_TYPES.find(t => t.id === typeId);
            const now = new Date();
            const dateStr = now.toLocaleDateString('az-AZ');
            const timeStr = now.toLocaleTimeString('az-AZ');

            console.log('‚úÖ Skan uƒüurludur:');
            console.log('   - Talon:', ticketType.name);
            console.log('   - ∆èm…ôkda≈ü ID:', empId);
            console.log('   - Tarix:', dateStr);
            console.log('   - Saat:', timeStr);

            // ‚úÖ TARIX∆è ∆èLAV∆è ET
            addToHistory(empId, ticketType.name, ticketType.emoji, dateStr, timeStr);

            // ‚úÖ SHEET-∆èYAZ‚ÑÇ
            const sheetData = {
                tarix: dateStr,
                saat: timeStr,
                id: empId,
                adSoyad: 'Bilinm…ôyan',
                talonNovu: ticketType.name,
                talonId: 'QR-' + Date.now(),
                status: 'T…ôsdiql…ôndi'
            };

            sendToSheet(sheetData);

            // ‚úÖ 3 SANƒ∞Y∆è SONRA YENID∆èN SKAN
            setTimeout(() => { 
                scanActive = true;
                console.log('üîÑ Yenid…ôn skan hazƒ±r');
            }, 3000);
        }

        // ============================================================
        // TARIX∆è ∆èLAV∆è ET
        // ============================================================
        function addToHistory(empId, name, emoji, dateStr, timeStr) {
            scanHistory.unshift({
                empId,
                name,
                emoji,
                date: dateStr,
                time: timeStr,
                timestamp: Date.now()
            });

            // Max 100 skan saxla
            if (scanHistory.length > 100) {
                scanHistory = scanHistory.slice(0, 100);
            }

            saveScanHistory();
            updateHistoryUI();
            console.log('üíæ Tarix…ô …ôlav…ô olundu. C…ômi skan:', scanHistory.length);
        }

        // ============================================================
        // GOOGLE SHEETS-∆èYAZ‚ÑÇ
        // ============================================================
        async function sendToSheet(data) {
            showSyncStatus('C…ôdv…ôl…ô yazƒ±lƒ±r...', 'loading');
            
            try {
                console.log('üì§ Google Sheets API-y…ô g√∂nd…ôrilir:');
                console.log('URL:', SHEET_API_URL);
                console.log('M…ôlumat:', data);
                
                const response = await fetch(SHEET_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                console.log('üì• Response Status:', response.status);
                console.log('üì• Response OK:', response.ok);

                const responseText = await response.text();
                console.log('üì• Response Text:', responseText);

                if (response.ok || response.status === 200) {
                    showSyncStatus('‚úÖ C…ôdv…ôl…ô yazƒ±ldƒ±!', 'success');
                    console.log('‚úÖ Uƒüurlu yazƒ±ldƒ±');
                } else {
                    showSyncStatus('‚ö†Ô∏è Cavab: ' + response.status, 'error');
                    console.warn('‚ö†Ô∏è Status:', response.status);
                }
                
            } catch (error) {
                console.error('‚ùå Fetch X…ôtasƒ±:', error);
                console.error('X…ôta Mesajƒ±:', error.message);
                showSyncStatus('‚ùå X…ôta: ' + error.message, 'error');
            } finally {
                setTimeout(() => { hideSyncStatus(); }, 3000);
            }
        }

        // ============================================================
        // SYNC STATUS
        // ============================================================
        function showSyncStatus(message, type) {
            const status = document.getElementById('syncStatus');
            status.textContent = message;
            status.className = `sync-status sync-${type}`;
            status.style.display = 'block';
        }

        function hideSyncStatus() {
            document.getElementById('syncStatus').style.display = 'none';
        }
    </script>
</body>
</html>
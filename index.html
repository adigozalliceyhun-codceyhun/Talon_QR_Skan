<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>GHG Yem…ôk Skaner</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f0f2f5;min-height:100vh}
    .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:15px;text-align:center}
    .header h1{font-size:1.3em}
    .container{max-width:600px;margin:0 auto;padding:15px}
    .scanner-box{background:#fff;border-radius:20px;padding:15px;margin-bottom:15px;box-shadow:0 4px 15px rgba(0,0,0,.1)}
    #reader{width:100%;border-radius:16px;overflow:hidden}
    .status{text-align:center;padding:12px;margin-top:10px;border-radius:12px;font-weight:600;font-size:.95em}
    .status-waiting{background:#fff3e0;color:#e65100}
    .status-scanning{background:#e3f2fd;color:#1565c0}
    .status-success{background:#e8f5e9;color:#2e7d32}
    .status-warning{background:#fff3e0;color:#f57c00}
    .status-error{background:#ffebee;color:#c62828}

    .result-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:1000;justify-content:center;align-items:center;padding:20px}
    .result-card{background:#fff;border-radius:24px;padding:26px;width:100%;max-width:420px;text-align:center}
    .result-icon{width:90px;height:90px;border-radius:50%;margin:0 auto 18px;display:flex;align-items:center;justify-content:center;font-size:46px}
    .result-success .result-icon{background:#e8f5e9;color:#4caf50}
    .result-warning .result-icon{background:#fff3e0;color:#ff9800}
    .result-error .result-icon{background:#ffebee;color:#f44336}
    .result-title{font-size:1.3em;font-weight:800;margin-bottom:14px}
    .result-details{background:#f5f5f5;border-radius:16px;padding:16px;margin-bottom:14px;text-align:left}
    .detail-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e0e0e0}
    .detail-row:last-child{border-bottom:none}
    .detail-label{color:#666;font-size:.9em}
    .detail-value{color:#333;font-weight:700;font-size:.95em}

    .btn{border:none;border-radius:14px;padding:12px 14px;font-weight:800;cursor:pointer;width:100%}
    .btn-confirm{background:#4caf50;color:#fff;margin-top:10px}
    .btn-close{background:#e0e0e0;color:#111;margin-top:10px}

    .countdown{font-size:2.2em;font-weight:800;color:#667eea;margin-top:10px}
    .countdown-text{color:#999;font-size:.9em;margin-top:5px}

    .last-scan{background:#fff;border-radius:20px;padding:20px;box-shadow:0 4px 15px rgba(0,0,0,.1)}
    .last-scan h2{font-size:1.1em;color:#333;margin-bottom:15px}
    .scan-item{display:flex;align-items:center;padding:12px;border-bottom:1px solid #eee}
    .scan-item:last-child{border-bottom:none}
    .scan-icon{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;margin-right:12px;flex-shrink:0}
    .scan-icon.ok{background:#e8f5e9;color:#4caf50}
    .scan-icon.warn{background:#fff3e0;color:#ff9800}
    .scan-icon.err{background:#ffebee;color:#f44336}
    .scan-info{flex:1;min-width:0}
    .scan-name{font-weight:700;color:#333;font-size:.95em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .scan-detail{color:#666;font-size:.8em;margin-top:2px}
    .scan-time{color:#999;font-size:.75em;margin-top:2px}
  </style>
</head>
<body>
  <div class="header"><h1>üçΩÔ∏è GHG Yem…ôk Skaner</h1></div>

  <div class="container">
    <div class="scanner-box">
      <div id="reader"></div>
      <div class="status status-waiting" id="status">QR kod g√∂zl…ônilir...</div>
    </div>

    <div class="last-scan">
      <h2>üìã Son skan edil…ônl…ôr</h2>
      <div id="scanList">
        <div style="text-align:center;color:#999;padding:20px;">H…ôl…ô he√ß bir skan edilm…ôyib</div>
      </div>
    </div>
  </div>

  <div class="result-overlay" id="resultOverlay">
    <div class="result-card" id="resultCard">
      <div class="result-icon" id="resultIcon">‚úì</div>
      <div class="result-title" id="resultTitle">T…ôsdiql…ôndi</div>

      <div class="result-details">
        <div class="detail-row"><span class="detail-label">∆èm…ôkda≈ü:</span><span class="detail-value" id="detailName">-</span></div>
        <div class="detail-row"><span class="detail-label">ID:</span><span class="detail-value" id="detailId">-</span></div>
        <div class="detail-row"><span class="detail-label">Talon:</span><span class="detail-value" id="detailTicket">-</span></div>
        <div class="detail-row"><span class="detail-label">Status:</span><span class="detail-value" id="detailStatus">-</span></div>
      </div>

      <button class="btn btn-confirm" id="confirmBtn" style="display:none;">‚úÖ T…ôsdiq et</button>
      <button class="btn btn-close" id="closeBtn">Baƒüla</button>

      <div class="countdown" id="countdown" style="display:none;">5</div>
      <div class="countdown-text" id="countdownText" style="display:none;">saniy…ô sonra skaner…ô qayƒ±dƒ±lƒ±r</div>
    </div>
  </div>

  <script>
    const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbxtHn5BnqLDYJj3HYe_0LZEQtX5B5AjLUUapjUmlj3jn1sCGsZmAIW817qfr9lQlh-i/exec';

    const COUNTDOWN_SECONDS = 5;
    const LAST_QR_COOLDOWN_MS = 900; // daha √ßevik

    let isProcessing = false;
    let scanHistory = [];
    let html5QrCode = null;
    let countdownInterval = null;

    // confirm √º√ß√ºn
    let pendingConfirmToken = null;
    let pendingConfirmQrData = null;
    let pendingConfirmMeta = null;

    // dedup
    let lastQrText = '';
    let lastQrAt = 0;

    // ‚úÖ yalnƒ±z Quru: eyni QR √º√ß√ºn sayƒüac
    // 0: he√ß istifad…ô olmayƒ±b, 1: 1-ci t…ôsdiql…ônib, 2: 2-ci d…ô t…ôsdiql…ônib (3-c√º -> t…ôkrar c…ôhd)
    const dryCountMap = new Map(); // qrData -> {count, ts}
    const DRY_TTL_MS = 24 * 60 * 60 * 1000;

    function isDryQR(qrData){
      const parts = String(qrData || '').split('|');
      const code = parts[2];   // Q
      const last = parts[5];   // dry
      return code === 'Q' || last === 'dry' || String(qrData).includes('|Q|') || String(qrData).includes('|dry');
    }

    function getDryCount(qrData){
      const row = dryCountMap.get(qrData);
      if (!row) return 0;
      if (Date.now() - row.ts > DRY_TTL_MS){ dryCountMap.delete(qrData); return 0; }
      return row.count || 0;
    }

    function setDryCount(qrData, count){
      if (!qrData) return;
      dryCountMap.set(qrData, {count, ts: Date.now()});
    }

    function fetchJSONP(url) {
      return new Promise((resolve, reject) => {
        const cb = 'cb_' + Date.now() + '_' + Math.floor(Math.random()*1000);
        const script = document.createElement('script');

        window[cb] = (data) => {
          delete window[cb];
          script.remove();
          resolve(data);
        };

        const t = setTimeout(() => {
          if (window[cb]) delete window[cb];
          script.remove();
          reject(new Error('Timeout'));
        }, 8000);

        script.onerror = () => { clearTimeout(t); reject(new Error('Load error')); };
        script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
        document.head.appendChild(script);
      });
    }

    function updateStatus(type, text){
      const s = document.getElementById('status');
      s.className = 'status status-' + type;
      s.textContent = text;
    }

    function addScan(item){
      const time = new Date().toLocaleTimeString('az-AZ');
      scanHistory.unshift({...item, time});
      if (scanHistory.length > 10) scanHistory.pop();

      const list = document.getElementById('scanList');
      list.innerHTML = scanHistory.map(scan=>{
        let icon='‚úì', cls='ok';
        if (scan.err) { icon='‚úï'; cls='err'; }
        else if (scan.warn) { icon='‚ö†'; cls='warn'; }

        return `
          <div class="scan-item">
            <div class="scan-icon ${cls}">${icon}</div>
            <div class="scan-info">
              <div class="scan-name">${scan.name}</div>
              <div class="scan-detail">${scan.id} ${scan.type ? '| ' + scan.type : ''} | ${scan.msg}</div>
              <div class="scan-time">${scan.time}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function startCountdown(){
      if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }

      const countdownEl = document.getElementById('countdown');
      const countdownText = document.getElementById('countdownText');

      countdownEl.style.display = 'block';
      countdownText.style.display = 'block';

      let seconds = COUNTDOWN_SECONDS;
      countdownEl.textContent = seconds;

      countdownInterval = setInterval(()=>{
        seconds--;
        countdownEl.textContent = seconds;
        if (seconds <= 0){
          clearInterval(countdownInterval);
          countdownInterval = null;
          hideResult();
        }
      }, 1000);
    }

    function showResult({resultType, name, id, type, statusText, confirmToken}){
      document.getElementById('countdown').textContent = COUNTDOWN_SECONDS;

      const overlay = document.getElementById('resultOverlay');
      const card = document.getElementById('resultCard');
      const icon = document.getElementById('resultIcon');
      const title = document.getElementById('resultTitle');

      document.getElementById('detailName').textContent = name || '-';
      document.getElementById('detailId').textContent = id || '-';
      document.getElementById('detailTicket').textContent = type || '-';
      document.getElementById('detailStatus').textContent = statusText || '-';

      card.className = 'result-card result-' + resultType;

      const confirmBtn = document.getElementById('confirmBtn');
      const closeBtn = document.getElementById('closeBtn');

      pendingConfirmToken = confirmToken || null;

      closeBtn.disabled = false;
      closeBtn.style.opacity = '1';
      closeBtn.style.cursor = 'pointer';

      confirmBtn.disabled = false;
      confirmBtn.style.opacity = '1';
      confirmBtn.style.cursor = 'pointer';
      confirmBtn.textContent = '‚úÖ T…ôsdiq et';

      if (resultType === 'success'){
        icon.textContent='‚úì'; title.textContent='T…ôsdiql…ôndi';
        confirmBtn.style.display='none';
        closeBtn.disabled = true; closeBtn.style.opacity = '.6'; closeBtn.style.cursor = 'not-allowed';
        startCountdown();
      } else if (resultType === 'warning'){
        icon.textContent='‚ö†'; title.textContent='X…ôb…ôrdarlƒ±q';
        confirmBtn.style.display='none';
        closeBtn.disabled = true; closeBtn.style.opacity = '.6'; closeBtn.style.cursor = 'not-allowed';
        startCountdown();
      } else if (resultType === 'confirm'){
        icon.textContent='?'; title.textContent='T…ôsdiq';
        confirmBtn.style.display='block';

        document.getElementById('countdown').style.display='none';
        document.getElementById('countdownText').style.display='none';
        if (countdownInterval){ clearInterval(countdownInterval); countdownInterval = null; }
      } else {
        icon.textContent='‚úï'; title.textContent='X…ôta';
        confirmBtn.style.display='none';
        closeBtn.disabled = true; closeBtn.style.opacity = '.6'; closeBtn.style.cursor = 'not-allowed';
        startCountdown();
      }

      overlay.style.display='flex';
    }

    function hideResult(){
      document.getElementById('resultOverlay').style.display='none';

      pendingConfirmToken = null;
      pendingConfirmQrData = null;
      pendingConfirmMeta = null;

      const closeBtn = document.getElementById('closeBtn');
      closeBtn.disabled = false;
      closeBtn.style.opacity = '1';
      closeBtn.style.cursor = 'pointer';

      document.getElementById('countdown').style.display='none';
      document.getElementById('countdownText').style.display='none';

      isProcessing = false;
      updateStatus('waiting','QR kod g√∂zl…ônilir...');
    }

    function shouldDropDuplicate(qrText){
      const now = Date.now();
      if (qrText === lastQrText && (now - lastQrAt) < LAST_QR_COOLDOWN_MS) return true;
      lastQrText = qrText;
      lastQrAt = now;
      return false;
    }

    // ‚úÖ Lokal qaydaya uyƒüun olaraq Quru Talonun UI axƒ±nƒ±
    function handleDryLocalFlow(qrData){
      const count = getDryCount(qrData);

      // 3-c√º v…ô sonrasƒ± -> T…ôkrar c…ôhd
      if (count >= 2){
        updateStatus('warning','T…ôkrar c…ôhd');
        addScan({name:'-', id:'-', type:'Quru Talon', msg:'T…ôkrar c…ôhd', warn:true, err:false});
        showResult({resultType:'warning', name:'-', id:'-', type:'Quru Talon', statusText:'T…ôkrar c…ôhd'});
        return true; // handled
      }

      return false; // server…ô ged…ôk
    }

    async function handleScan(qrData){
      if (shouldDropDuplicate(qrData)) return;
      if (isProcessing) return;

      // ‚úÖ Quru talonda 3-c√º v…ô sonrasƒ± lokal "T…ôkrar c…ôhd"
      if (isDryQR(qrData)){
        isProcessing = true;
        const handled = handleDryLocalFlow(qrData);
        if (handled) return;
        // handled deyils…ô: 1-ci v…ô ya 2-ci axƒ±n √º√ß√ºn server…ô gedirik
        // isProcessing true qalƒ±r, a≈üaƒüƒ±da davam ed…ôc…ôk
      } else {
        isProcessing = true;
      }

      updateStatus('scanning','Yoxlanƒ±lƒ±r...');

      try{
        const res = await fetchJSONP(`${SHEET_API_URL}?action=scanTicket&qrData=${encodeURIComponent(qrData)}`);

        // m…ôlumatlarƒ± √ßƒ±xar
        const name = res.data?.adSoyad || '-';
        const id = res.data?.empId || '-';
        const ticketType = res.data?.ticketType || '-';
        const isDry = isDryQR(qrData) || String(ticketType).toLowerCase().includes('quru');

        // ‚úÖ 1-ci Quru skan: success -> count=1
        if (res.status === 'success'){
          if (isDry){
            setDryCount(qrData, 1);
          }
          addScan({name, id, type: ticketType, msg: res.message || 'T…ôsdiql…ôndi', warn:false, err:false});
          showResult({resultType:'success', name, id, type: ticketType, statusText: res.message || 'T…ôsdiql…ôndi'});
          return;
        }

        // ‚úÖ 2-ci Quru skan: ist…ônil…ôn halda confirm d√ºym…ôsi √ßƒ±xacaq (token varsa daha yax≈üƒ±)
        if (isDry && getDryCount(qrData) === 1){
          const token =
            res.token ||
            res.confirmToken ||
            res.data?.token ||
            res.data?.confirmToken ||
            null;

          pendingConfirmQrData = qrData;
          pendingConfirmMeta = {
            name, id,
            type: 'Quru Talon',
            msg: '2-ci d…ôf…ôdir. T…ôsdiq t…ôl…ôb olunur.'
          };

          addScan({name, id, type:'Quru Talon', msg:'T…ôsdiq t…ôl…ôb olunur', warn:true, err:false});
          showResult({
            resultType:'confirm',
            name, id,
            type:'Quru Talon',
            statusText:'2-ci d…ôf…ôdir. T…ôsdiq edin.',
            confirmToken: token
          });
          return;
        }

        // Dig…ôr hallarda warning/error normal g√∂st…ôr
        if (res.status === 'warning'){
          addScan({name, id, type: ticketType, msg: res.message || 'X…ôb…ôrdarlƒ±q', warn:true, err:false});
          showResult({resultType:'warning', name, id, type: ticketType, statusText: res.message || 'X…ôb…ôrdarlƒ±q'});
          return;
        }

        if (res.status === 'confirm'){
          // non-dry confirm
          const token =
            res.token ||
            res.confirmToken ||
            res.data?.token ||
            res.data?.confirmToken ||
            null;

          pendingConfirmQrData = qrData;
          pendingConfirmMeta = { name, id, type: ticketType, msg: res.message || 'T…ôsdiq t…ôl…ôb olunur' };

          addScan({name, id, type: ticketType, msg: pendingConfirmMeta.msg, warn:true, err:false});
          showResult({resultType:'confirm', name, id, type: ticketType, statusText: pendingConfirmMeta.msg, confirmToken: token});
          return;
        }

        addScan({name:'X…ôta', id:'-', type:'-', msg: res.message || 'X…ôta', err:true});
        showResult({resultType:'error', name:'X…ôta', id:'-', type:'-', statusText: res.message || 'X…ôta'});
      }catch(e){
        addScan({name:'Baƒülantƒ± x…ôtasƒ±', id:'-', type:'-', msg:'Server…ô qo≈üulmadƒ±', err:true});
        showResult({resultType:'error', name:'Baƒülantƒ± x…ôtasƒ±', id:'-', type:'-', statusText:'Server…ô qo≈üulmadƒ±'});
      }
    }

    document.getElementById('confirmBtn').onclick = async () => {
      const btn = document.getElementById('confirmBtn');

      // token olmasa da qrData il…ô ged…ôc…ôk
      btn.disabled = true;
      btn.textContent = 'G√∂nd…ôrilir...';

      const meta = pendingConfirmMeta || {name:'-', id:'-', type:'-'};
      const qrData = pendingConfirmQrData || '';
      const token = pendingConfirmToken || '';

      // ‚úÖ Quru talonda confirm basƒ±ldƒ± -> 2-ci istifad…ô t…ôsdiql…ôndi -> count=2
      if (isDryQR(qrData) || String(meta.type).toLowerCase().includes('quru')){
        setDryCount(qrData, 2);
      }

      // UX: d…ôrhal success g√∂st…ôr
      showResult({
        resultType:'success',
        name: meta.name,
        id: meta.id,
        type: meta.type,
        statusText: 'T…ôsdiql…ôndi ‚úÖ'
      });

      try{
        const url =
          `${SHEET_API_URL}?action=confirmDrySecond` +
          `&token=${encodeURIComponent(token)}` +
          `&confirmToken=${encodeURIComponent(token)}` +
          `&qrData=${encodeURIComponent(qrData)}`;

        const res = await fetchJSONP(url);

        // backend a√ßƒ±q error ver…ôrs…ô g√∂st…ôr
        if (res && (res.status === 'error' || res.status === 'failed')){
          addScan({name: meta.name, id: meta.id, type: meta.type, msg: res.message || 'T…ôsdiq alƒ±nmadƒ±', err:true});
          showResult({resultType:'error', name: meta.name, id: meta.id, type: meta.type, statusText: res.message || 'T…ôsdiq alƒ±nmadƒ±'});
          return;
        }

        addScan({name: meta.name, id: meta.id, type: meta.type, msg: 'T…ôsdiql…ôndi', warn:false, err:false});
      }catch(e){
        addScan({name: meta.name, id: meta.id, type: meta.type, msg: 'Server cavabƒ± gecikdi', warn:true, err:false});
        // UX-d…ô artƒ±q t…ôsdiq g√∂st…ôrilib ‚Äî log √º√ß√ºn warning kifay…ôtdir
      } finally {
        btn.textContent = 'G√∂nd…ôrildi ‚úÖ';
      }
    };

    document.getElementById('closeBtn').onclick = () => {
      const closeBtn = document.getElementById('closeBtn');
      if (closeBtn.disabled) return;
      if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
      hideResult();
    };

    function startCamera(){
      html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start(
        { facingMode:"environment" },
        {
          fps: 18,
          qrbox: { width: 280, height: 280 },
          aspectRatio: 1.7777778,
          disableFlip: true
        },
        (text)=>{ if (!isProcessing) handleScan(text); },
        ()=>{}
      ).catch(err=>{
        updateStatus('error','Kamera a√ßƒ±lmadƒ±!');
        console.error(err);
      });
    }

    window.onload = startCamera;
    window.onbeforeunload = ()=>{
      try{ if (html5QrCode) html5QrCode.stop(); }catch(e){}
      if (countdownInterval) clearInterval(countdownInterval);
    };
  </script>
</body>
</html>
